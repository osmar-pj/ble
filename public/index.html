<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>GUNJOP - UNDIS</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #1a1b26;
      color: #c0caf5;
      min-height: 100vh;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 1rem;
      min-height: 2.5rem;
    }
    .header-unit {
      font-size: 1.25rem;
      font-weight: 600;
      color: #7aa2f7;
      text-align: center;
    }
    .header-unit.empty { color: #e0af68; }
    .config-warn {
      background: #363b54;
      border-left: 4px solid #e0af68;
      padding: 0.6rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #e0af68;
      border-radius: 0 8px 8px 0;
    }
    .scan-btn {
      display: block;
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1.2rem;
      font-weight: 600;
      color: #1a1b26;
      background: #7aa2f7;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 1.5rem;
      -webkit-tap-highlight-color: transparent;
    }
    .scan-btn:active { opacity: 0.9; }
    .scan-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      font-size: 0.9rem;
      color: #9ece6a;
      margin-bottom: 1rem;
      min-height: 1.4em;
    }
    .status.error { color: #f7768e; }
    .status.scanning { color: #e0af68; }
    .list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .list li {
      padding: 1rem 1.25rem;
      background: #24283b;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .list .name { font-weight: 500; }
    .list .address { font-size: 0.85rem; color: #565f89; }
    .list .rssi { font-size: 0.85rem; color: #e0af68; min-width: 4rem; text-align: right; }
    .empty { color: #565f89; text-align: center; padding: 2rem; }
    .tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #363b54;
    }
    .tabs button {
      padding: 0.6rem 1rem;
      background: none;
      border: none;
      color: #565f89;
      cursor: pointer;
      font-size: 0.95rem;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tabs button.active {
      color: #7aa2f7;
      border-bottom-color: #7aa2f7;
    }
    .tabs button:hover { color: #c0caf5; }
    .view { display: none; }
    .view.active { display: block; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td { padding: 0.6rem 0.75rem; text-align: left; }
    th {
      color: #565f89;
      font-weight: 500;
      border-bottom: 1px solid #363b54;
    }
    tr { border-bottom: 1px solid #24283b; }
    tr:last-child { border-bottom: none; }
    .table-address { font-family: monospace; font-size: 0.8rem; color: #565f89; }
    .wifi-corner {
      position: fixed;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: #9ece6a;
      background: #24283b;
      padding: 0.4rem 0.6rem;
      border-radius: 8px;
    }
    .wifi-corner.off { color: #565f89; }
    .wifi-corner svg { width: 1.1rem; height: 1.1rem; flex-shrink: 0; }
    .sync-corner {
      position: fixed;
      top: 0.75rem;
      left: 0.75rem;
      font-size: 0.8rem;
      background: #24283b;
      padding: 0.4rem 0.6rem;
      border-radius: 8px;
      color: #9ece6a;
      z-index: 10;
    }
    .sync-corner.pending { color: #e0af68; }
    .sync-corner svg { width: 1rem; height: 1rem; vertical-align: -0.15em; margin-right: 0.2rem; }
    .settings-form { max-width: 28rem; }
    .settings-group {
      border: 1px solid #363b54;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #24283b;
    }
    .settings-group legend {
      color: #7aa2f7;
      font-size: 0.9rem;
      padding: 0 0.5rem;
    }
    .settings-form label {
      display: block;
      margin-bottom: 0.75rem;
    }
    .settings-form label span {
      display: block;
      font-size: 0.85rem;
      color: #565f89;
      margin-bottom: 0.25rem;
    }
    .settings-form input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: #1a1b26;
      border: 1px solid #363b54;
      border-radius: 6px;
      color: #c0caf5;
      font-size: 0.95rem;
    }
    .settings-form input::placeholder { color: #565f89; }
    .settings-status {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      min-height: 1.4em;
    }
    .settings-status.ok { color: #9ece6a; }
    .settings-status.error { color: #f7768e; }
  </style>
</head>
<body>
  <div class="sync-corner" id="syncCorner" aria-label="Estado de sincronización" style="display: none;">
    <span id="syncLabel">—</span>
  </div>
  <div class="wifi-corner off" id="wifiCorner" aria-label="Estado WiFi">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.7 2.09 7.3 2.09 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
    </svg>
    <span id="wifiLabel">—</span>
  </div>
  <header class="header">
    <span class="header-unit" id="headerUnitId">—</span>
  </header>
  <div class="config-warn" id="configWarn" style="display: none;"></div>
  <nav class="tabs" role="tablist">
    <button type="button" role="tab" id="tabLive" aria-selected="true">En vivo</button>
    <button type="button" role="tab" id="tabHistory" aria-selected="false">Historial</button>
    <button type="button" role="tab" id="tabSettings" aria-selected="false">Configuración</button>
  </nav>
  <p class="status" id="status" aria-live="polite">Escaneo automático (MAC AF2024)</p>
  <div id="viewLive" class="view active" role="tabpanel">
    <div id="liveWrap">
      <table>
        <thead>
          <tr>
            <th>Beacon</th>
            <th>RSSI</th>
            <th>Inicio detección</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
    <p class="empty" id="liveEmpty">No hay dispositivos. El escaneo es automático.</p>
  </div>
  <div id="viewHistory" class="view" role="tabpanel">
    <div id="sessionsWrap">
      <table>
        <thead>
          <tr>
            <th>Beacon</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody id="sessionsTable"></tbody>
      </table>
    </div>
    <p class="empty" id="sessionsEmpty">Sin sesiones registradas</p>
  </div>
  <div id="viewSettings" class="view" role="tabpanel">
    <form id="settingsForm" class="settings-form">
      <fieldset class="settings-group">
        <legend>MQTT</legend>
        <label>
          <span>URL</span>
          <input type="text" name="MQTT_URL" placeholder="mqtt://host:1883">
        </label>
        <label>
          <span>Topic</span>
          <input type="text" name="MQTT_TOPIC" placeholder="porvenir/unit/truck_20">
        </label>
        <label>
          <span>Client ID</span>
          <input type="text" name="MQTT_CLIENT_ID" placeholder="truck_20">
        </label>
        <label>
          <span>Usuario</span>
          <input type="text" name="MQTT_USERNAME" placeholder="">
        </label>
        <label>
          <span>Contraseña</span>
          <input type="password" name="MQTT_PASSWORD" placeholder="">
        </label>
      </fieldset>
      <fieldset class="settings-group">
        <legend>Sync</legend>
        <label>
          <span>Servidor URL</span>
          <input type="text" name="SYNC_SERVER_URL" placeholder="http://192.168.1.50">
        </label>
      </fieldset>
      <fieldset class="settings-group">
        <legend>Unidad y Bluetooth</legend>
        <label>
          <span>Unit ID</span>
          <input type="text" name="UNIT_ID" placeholder="truck_20">
        </label>
        <label>
          <span>MAC Filter</span>
          <input type="text" name="MAC_FILTER" placeholder="AF2024">
        </label>
        <label>
          <span>RSSI Stale (ms)</span>
          <input type="number" name="RSSI_STALE_MS" placeholder="10000">
        </label>
      </fieldset>
      <p class="settings-status" id="settingsStatus"></p>
      <button type="submit" class="scan-btn">Guardar configuración</button>
    </form>
  </div>

  <script>
    const status = document.getElementById('status');
    const listEl = document.getElementById('list');

    const setStatus = (msg, type = '') => {
      status.textContent = msg;
      status.className = 'status ' + type;
    };

    const escapeHtml = (s) => {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    };

    const formatTime = (ts) => ts ? new Date(ts).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '—';
    const formatDuration = (ms) => {
      if (!ms || ms < 0) return '—';
      const s = Math.floor(ms / 1000);
      if (s < 60) return `${s}s`;
      const m = Math.floor(s / 60);
      return m < 60 ? `${m}m ${s % 60}s` : `${Math.floor(m / 60)}h ${m % 60}m`;
    };

    const headerUnitId = document.getElementById('headerUnitId');
    const configWarn = document.getElementById('configWarn');

    const updateHeader = (unitId, configIncomplete) => {
      headerUnitId.textContent = unitId || '—';
      headerUnitId.classList.toggle('empty', !unitId || unitId === '—');
      if (configIncomplete && configIncomplete.length > 0) {
        configWarn.style.display = 'block';
        configWarn.textContent = 'Complete la configuración en el menú Configuración: ' + configIncomplete.join(', ');
      } else {
        configWarn.style.display = 'none';
      }
    };

    const renderDevices = (devices) => {
      const hasDevices = devices.length > 0;
      document.getElementById('liveWrap').style.display = hasDevices ? 'block' : 'none';
      document.getElementById('liveEmpty').style.display = hasDevices ? 'none' : 'block';
      if (!hasDevices) {
        listEl.innerHTML = '';
        setStatus('Sin dispositivos (MAC AF2024)');
        return;
      }
      listEl.innerHTML = devices.map(d => {
        const rssiStr = d.rssi != null ? `${d.rssi} dBm` : '—';
        const inicio = formatTime(d.firstSeenAt);
        return `<tr><td><span class="name">${escapeHtml(d.name)}</span><br><span class="table-address">${escapeHtml(d.address)}</span></td><td>${escapeHtml(rssiStr)}</td><td>${escapeHtml(inicio)}</td></tr>`;
      }).join('');
      setStatus(`${devices.length} dispositivos (MAC AF2024) — actualización automática`);
    };

    const sessionsTable = document.getElementById('sessionsTable');
    const sessionsEmpty = document.getElementById('sessionsEmpty');
    const sessionsWrap = document.getElementById('sessionsWrap');

    const renderSessions = (sessions) => {
      const hasData = sessions && sessions.length > 0;
      sessionsWrap.style.display = hasData ? 'block' : 'none';
      sessionsEmpty.style.display = hasData ? 'none' : 'block';
      if (!hasData) {
        sessionsTable.innerHTML = '';
        return;
      }
      sessionsTable.innerHTML = sessions.map(s => `
        <tr>
          <td><span class="name">${escapeHtml(s.name)}</span><br><span class="table-address">${escapeHtml(s.address)}</span></td>
          <td>${escapeHtml(formatTime(s.firstSeen))}</td>
          <td>${escapeHtml(formatTime(s.lastSeen))}</td>
          <td>${escapeHtml(formatDuration(s.durationMs))}</td>
        </tr>
      `).join('');
    };

    const refreshDevices = async () => {
      try {
        const r = await fetch(`/api/devices?t=${Date.now()}`);
        const data = await r.json();
        if (data.ok) {
          updateHeader(data.unitId, data.configIncomplete);
          renderDevices(data.devices || []);
        }
      } catch (e) {
        setStatus('Error al cargar: ' + e.message, 'error');
      }
    };

    const refreshSessions = async () => {
      try {
        const r = await fetch(`/api/sessions?t=${Date.now()}`);
        const data = await r.json();
        if (data.ok) renderSessions(data.sessions || []);
      } catch (_) {}
    };

    const wifiCorner = document.getElementById('wifiCorner');
    const wifiLabel = document.getElementById('wifiLabel');

    const refreshWifi = async () => {
      try {
        const r = await fetch('/api/wifi');
        const { connected, ssid } = await r.json();
        wifiCorner.classList.toggle('off', !connected);
        wifiLabel.textContent = connected && ssid ? ssid : 'Desconectado';
      } catch (_) {
        wifiCorner.classList.add('off');
        wifiLabel.textContent = '—';
      }
    };

    const syncCorner = document.getElementById('syncCorner');
    const syncLabel = document.getElementById('syncLabel');

    const refreshSyncStatus = async () => {
      try {
        const r = await fetch('/api/sync/status?t=' + Date.now());
        const data = await r.json();
        if (!data.ok) {
          syncCorner.style.display = 'none';
          return;
        }
        const pending = data.pending ?? 0;
        const syncEnabled = data.syncEnabled;
        if (!syncEnabled && pending === 0) {
          syncCorner.style.display = 'none';
          return;
        }
        syncCorner.style.display = 'flex';
        if (pending > 0) {
          syncCorner.classList.add('pending');
          syncLabel.textContent = `${pending} pendientes de enviar`;
          syncCorner.title = syncEnabled
            ? `${pending} sesiones esperando conexión con el servidor. Se enviarán cuando haya señal.`
            : `Configure la URL del servidor en Configuración para enviar ${pending} sesiones.`;
        } else {
          syncCorner.classList.remove('pending');
          syncLabel.textContent = 'Todo enviado';
          syncCorner.title = 'No hay sesiones pendientes. Todo se ha enviado al servidor.';
        }
      } catch (_) {
        syncCorner.style.display = 'none';
      }
    };

    const tabLive = document.getElementById('tabLive');
    const tabHistory = document.getElementById('tabHistory');
    const tabSettings = document.getElementById('tabSettings');
    const viewLive = document.getElementById('viewLive');
    const viewHistory = document.getElementById('viewHistory');
    const viewSettings = document.getElementById('viewSettings');

    const loadSettings = async () => {
      try {
        const r = await fetch('/api/settings');
        const data = await r.json();
        if (data.ok && data.settings) {
          const form = document.getElementById('settingsForm');
          for (const [key, value] of Object.entries(data.settings)) {
            const input = form.elements[key];
            if (input) input.value = value || '';
          }
        }
      } catch (_) {}
    };

    const settingsForm = document.getElementById('settingsForm');
    const settingsStatus = document.getElementById('settingsStatus');

    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      settingsStatus.textContent = 'Guardando…';
      settingsStatus.className = 'settings-status';
      try {
        const formData = new FormData(settingsForm);
        const body = {};
        for (const [k, v] of formData) body[k] = v;
        const r = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await r.json();
        if (data.ok) {
          settingsStatus.textContent = 'Configuración guardada';
          settingsStatus.className = 'settings-status ok';
          refreshDevices();
          refreshSyncStatus();
        } else {
          settingsStatus.textContent = data.error || 'Error al guardar';
          settingsStatus.className = 'settings-status error';
        }
      } catch (err) {
        settingsStatus.textContent = 'Error: ' + err.message;
        settingsStatus.className = 'settings-status error';
      }
    });

    tabLive.addEventListener('click', () => {
      tabLive.classList.add('active');
      tabLive.setAttribute('aria-selected', 'true');
      tabHistory.classList.remove('active');
      tabHistory.setAttribute('aria-selected', 'false');
      tabSettings.classList.remove('active');
      tabSettings.setAttribute('aria-selected', 'false');
      viewLive.classList.add('active');
      viewHistory.classList.remove('active');
      viewSettings.classList.remove('active');
    });
    tabHistory.addEventListener('click', () => {
      tabHistory.classList.add('active');
      tabHistory.setAttribute('aria-selected', 'true');
      tabLive.classList.remove('active');
      tabLive.setAttribute('aria-selected', 'false');
      tabSettings.classList.remove('active');
      tabSettings.setAttribute('aria-selected', 'false');
      viewHistory.classList.add('active');
      viewLive.classList.remove('active');
      viewSettings.classList.remove('active');
      refreshSessions();
    });
    tabSettings.addEventListener('click', () => {
      tabSettings.classList.add('active');
      tabSettings.setAttribute('aria-selected', 'true');
      tabLive.classList.remove('active');
      tabLive.setAttribute('aria-selected', 'false');
      tabHistory.classList.remove('active');
      tabHistory.setAttribute('aria-selected', 'false');
      viewSettings.classList.add('active');
      viewLive.classList.remove('active');
      viewHistory.classList.remove('active');
      loadSettings();
    });

    refreshDevices();
    refreshSessions();
    refreshWifi();
    refreshSyncStatus();
    setInterval(refreshDevices, 4000);
    setInterval(refreshSessions, 4000);
    setInterval(refreshWifi, 10000);
    setInterval(refreshSyncStatus, 8000);
  </script>
<script>document.addEventListener("keydown",function(e){if(e.key==="F1"||e.key==="F2"){e.preventDefault();e.stopPropagation();}});</script>
</body>
</html>
